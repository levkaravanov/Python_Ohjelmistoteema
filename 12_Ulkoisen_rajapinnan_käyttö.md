# Использование внешнего (ulkoisen rajapinnan käyttö)

В этом модуле вы научитесь использовать внешние программные интерфейсы (ohjelmointirajapintoja), позволяющие компьютерам обмениваться данными друг с другом.

Общие публичные интернет-провайдеры, такие как погодные сервисы и открытые базы данных, дают возможность пользоваться ими программно. Такое программное использование происходит через программный интерфейс (ohjelmointirajapinta). Поставщик услуг (palveluntarjoaja) решает, какой именно интерфейс (rajapinta) он предоставляет и как его используют. Для работы с интерфейсом всегда необходимо ознакомиться с его документацией.

## Передача данных в Интернете

Сначала рассмотрим работу сети Интернет с точки зрения того, как устройства, подключённые к сети, обмениваются данными. Так мы научимся понимать основы взаимодействия между устройствами.

Передача данных в Интернете основана на модели «клиент-сервер» (asiakas-palvelin-malli). Сервером (palvelin) называют компьютер, подключённый к сети и ожидающий входящих соединений. По сути, компьютер становится «сервером» (palvelinlaitteen) благодаря установленному на нём серверному программному обеспечению (palvelinohjelmisto), которое и занимается ожиданием запроса (request).

Когда в обиходной речи мы говорим «сервер» (palvelin), мы можем иметь в виду:
- компьютер, подключённый к сети и выполняющий роль серверного устройства (palvelinlaite), или
- само серверное программное обеспечение (palvelinohjelmisto), установленное на таком устройстве.

Согласно модели «клиент-сервер» (asiakas-palvelin-mallin), устройство, которое устанавливает соединение с сервером (palvelinkone) и серверным ПО (palvelinohjelmisto), первым отправляет запрос (request). Сервер обрабатывает запрос и формирует ответ (response):

![Asiakas-palvelin-malli](img/asiakas-palvelin.png)

Получение веб-страниц и их предоставление в Интернете опирается на модель «клиент-сервер» (asiakas-palvelinmalli). Например, когда вы вводите адрес сайта (или нажимаете ссылку), запрос уходит на веб-сервер (web-palvelin). Сервер возвращает в ответе HTML (HTML)-файл, содержащий описание веб-страницы. Если странице также нужны изображения, стили или другие ресурсы, на каждый ресурс отправляется новый запрос к веб-серверу, и нужные файлы возвращаются в ответе.

Аналогично можно получать не только веб-страницы, но и данные. Например, можно написать программу на Python (Python), которая получит прогноз погоды на сегодня или (как мы скоро сделаем) информацию о выбранном пользователем сериале с внешнего серверного компьютера (palvelinkone). В таком случае наша программа на Python (Python) отправляет запрос внешнему серверному компьютеру, а тот отвечает на него.

Поставщики услуг (например, погодный сервис или сервис поиска телесериалов) предоставляют так называемый сервисный интерфейс (palvelurajapinta). Документация интерфейса (rajapinnan kuvaus) описывает, какие запросы можно отправлять и в каком формате получается ответ.

## Отправка запроса

Запросы к интерфейсам соответствуют протоколу (HTTP (HTTP)). HTTP (HTTP) — это соглашение, основанное на модели «клиент-сервер» (asiakas-palvelinmalliin), которое определяет, как отправлять запросы и в каком виде получать ответы. Проще говоря, HTTP (HTTP) описывает «конверт», в который помещают запросы и ответы, чтобы они могли быть переданы через Интернет, а затем получить на них ответ. Протокол определяет, что каждый ответ состоит из заголовка и тела, и что вместе с ответом передаётся код статуса (status code (status_code)).

HTTP (HTTP) определяет пять распространённых операций в запросах:
- GET (GET) — чтение содержимого,
- PUT (PUT) — замена существующего содержимого,
- POST (POST) — создание нового содержимого,
- PATCH (PATCH) — изменение существующего содержимого,
- DELETE (DELETE) — удаление существующего содержимого.

Операция GET (GET) — та же операция, которую используют для обычных запросов веб-страниц. Если интерфейс (rajapinta) спроектирован по принципам REST (REST), то будут доступны все пять операций. REST (REST)-интерфейс (rajapinta) подразумевает и другие принципы проектирования, которые здесь не обсуждаются.

Рабочее определение интерфейса (rajapinnan määritys) может быть основано и на одной операции GET (GET), тогда это не будет полноценным REST (REST)-интерфейсом. На этом курсе мы рассматриваем работу и реализацию интерфейсов на базе GET (GET)-операций.

Рассмотрим пример использования интерфейса (rajapinnan käyttö), предлагаемого сервисом TVmaze (TVmaze). Документация к этому интерфейсу (rajapinnan dokumentaatio) находится по адресу https://www.tvmaze.com/api.

Это публичный открытый интерфейс (rajapinta), не требующий регистрации учётных записей. У подобных интерфейсов обычно разрешены только операции чтения. Они выполняются с помощью GET (GET)-запросов к интерфейсу (rajapintapyyntö).

Мы хотим написать программу на Python (Python), которая найдёт все шоу, в которых встречается строка, введённая пользователем. Согласно документации сервиса TVmaze (TVmaze), запрос формируется в виде URL (URL): /search/shows?q=:query, а примером запроса может служить https://api.tvmaze.com/search/shows?q=girls.

Вначале стоит проверить работу запроса, просто введя его в адресную строку браузера (например, Chrome). Обычно через браузер можно отправлять только GET (GET)-запросы.

Из программы на Python (Python) соответствующий запрос отправляется методом get (get) из пакета requests (requests). Метод json (json), вызванный у ответа, преобразует содержимое ответа в структуру словаря Python (Python):

```python
import requests

hakusana = input("Anna hakusana: ")

# Pyynnön malli: https://api.tvmaze.com/search/shows?q=girls
pyyntö = "https://api.tvmaze.com/search/shows?q=" + hakusana
vastaus = requests.get(pyyntö).json()
print(vastaus)
```

Проверим работу программы:
```monospace
Anna hakusana: python
[{'score': 0.6097852, 'show': {'id': 25376, 'url': 'https://www.tvmaze.com/shows/25376/python-hunters', ...
```

Запрос отправляется успешно, и мы получаем ответ. Интерфейс (rajapinta) возвращает ответ в формате JSON (JSON), а затем он преобразуется методом json (json) в структуру словаря Python (Python). (JSON (JSON) — это формат передачи данных, синтаксис которого основан на JavaScript (JavaScript) и который очень похож на структуру словаря в Python (Python).)

Полученный в виде словаря ответ нужно изучить и дальше обработать, чтобы вывести нужные данные.

## Обработка ответа

Выше мы получали результирующий ответ в словаре, помещённом в переменную vastaus. Чтобы лучше понять его структуру, можно использовать функцию json.dumps (json.dumps), которая делает вывод более наглядным. Вместо обычного print можно написать:
```python
print(json.dumps(vastaus, indent=2))
```
Для этого в начале программы нужно добавить строку:
```python
import json
```

Тогда результат становится более понятным. Он начинается так:

```json
[
  {
    "score": 0.6097852,
    "show": {
      "id": 25376,
      "url": "https://www.tvmaze.com/shows/25376/python-hunters",
      "name": "Python Hunters",
```

Видно, что результат представляет собой список, каждый элемент которого — словарь. В каждом словаре есть ключ show (show), значением которого является ещё один словарь. Внутри этого словаря есть ключ name (name), содержащий строковое название шоу. Например, к названию первого шоу из списка можно обратиться через vastaus[0]["show"]["name"].

Теперь можно заменить базовый вывод программы циклом for (for), выводящим названия всех шоу:
```python
for a in vastaus:
    print(a["show"]["name"])
```
Результат будет примерно таким:

```monospace
Python Hunters
Monty Python: Almost the Truth
Mytho
Monty Python's Flying Circus
```

## Обработка ошибок

Приведённая программа с внешним интерфейсом (ulkoista rajapintaa) работает, когда внешний сервис (здесь TV Maze (TVmaze)) функционирует и может обработать запрос. Но поскольку сервис внешний, мы не можем влиять на его работоспособность. Добавим в программу проверки на ошибки, чтобы в случае сбоя программа вела себя так, как нам нужно.

Здесь нас будут интересовать два момента:
1. Код статуса (status code (status_code)), который приходит вместе с ответом, 
2. Исключения (poikkeukset), возникающие в программе на Python (Python).

Если внешний сервис работает, он вернёт в ответе код статуса (status code (status_code)) 200 при успешном выполнении запроса. При ошибке возвращается другой код, в зависимости от её природы. Официальный список кодов статуса находится на сайте W3C (W3C): https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html. В программе код статуса можно проверить через свойство status_code (status_code) ответа, возвращаемого методом requests.get (requests.get). Здесь достаточно проверить, равен ли status_code (status_code) 200, или нет.

Иногда может случиться, что до внешнего сервиса вообще не удаётся «достучаться» и он даже не может вернуть код ошибки. В этом случае в Python (Python) произойдёт ошибка во время выполнения (ajonaikainen virhe), и программа просто «упадёт». Тогда нужно обрабатывать (käsittely) исключение. В Python (Python) для этого используется конструкция try/except (try/except).

Добавим проверку на статус 200 и блок обработки исключений для всех исключений, которые может выбросить библиотека requests (requests). Все исключения requests (requests) связаны с классом RequestException (RequestException). Вот так выглядит программа с учётом проверок:

```python
import json
import requests

hakusana = input("Anna hakusana: ")

# Pyynnön malli: https://api.tvmaze.com/search/shows?q=girls
pyyntö = "https://api.tvmaze.com/search/shows?q=" + hakusana

try:
    vastaus = requests.get(pyyntö)
    if vastaus.status_code==200:
        json_vastaus = vastaus.json()
        print(json.dumps(json_vastaus, indent=2))
        for a in json_vastaus:
            print(a["show"]["name"])
except requests.exceptions.RequestException as e:
    print ("Hakua ei voitu suorittaa.")
```

Проверим, что будет при ошибке. Специально испортим адрес (ошибка в «.com» меняется на «.cob»):

```python
pyyntö = "https://api.tvmaze.cob/search/shows?q=" + hakusana
```

Теперь программа не «падает», а выдаёт наше сообщение:

```monospace
Anna hakusana: python
Hakua ei voitu suorittaa.
```

В конце, конечно, нужно вернуть адрес в правильный вид. Благодаря обработке исключений мы можем реагировать, например, на ситуацию, когда у TV Maze (TVmaze) плановое обслуживание и сервис недоступен. Хорошим стилем программирования считается предусмотреть в программе такие проверки на ошибки.
